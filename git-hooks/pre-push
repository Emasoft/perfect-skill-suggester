#!/usr/bin/env bash
# pre-push hook - Validate plugin before allowing push
#
# Runs validate_plugin.py in strict mode: ALL severity levels
# (CRITICAL, MAJOR, MINOR) block the push.
#
# Exit codes from validate_plugin.py:
#   0 - All checks passed
#   1 - CRITICAL issues found (blocks push)
#   2 - MAJOR issues found (blocks push)
#   3 - MINOR issues found (blocks push)
#
# To install:
#   mkdir -p .git/hooks && cp git-hooks/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push
#
# To bypass (NOT RECOMMENDED):
#   git push --no-verify

set -euo pipefail

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the root directory of the git repository
REPO_ROOT="$(git rev-parse --show-toplevel)"

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  Pre-push Plugin Validation${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Check what's being pushed
REMOTE="$1"
URL="$2"

echo -e "${BLUE}Pushing to:${NC} $REMOTE ($URL)"
echo ""

# Check if plugin files changed in the commits being pushed
while read -r LOCAL_REF LOCAL_SHA REMOTE_REF REMOTE_SHA; do
    if [ "$LOCAL_SHA" = "0000000000000000000000000000000000000000" ]; then
        # Branch deletion, skip validation
        echo -e "${GREEN}Branch deletion detected. No validation needed.${NC}"
        continue
    fi

    if [ "$REMOTE_SHA" = "0000000000000000000000000000000000000000" ]; then
        # New branch, check all files
        CHANGED_FILES=$(git diff --name-only "$LOCAL_SHA" HEAD~10 2>/dev/null || git ls-tree -r --name-only "$LOCAL_SHA")
    else
        # Existing branch, check changed files
        CHANGED_FILES=$(git diff --name-only "$REMOTE_SHA..$LOCAL_SHA" 2>/dev/null || true)
    fi

    PLUGIN_FILES_CHANGED=false
    while IFS= read -r file; do
        case "$file" in
            .claude-plugin/*|agents/*|commands/*|skills/*|hooks/*|scripts/*.py|scripts/*.sh|*.mcp.json)
                PLUGIN_FILES_CHANGED=true
                ;;
        esac
    done <<< "$CHANGED_FILES"

    if [ "$PLUGIN_FILES_CHANGED" = false ]; then
        echo -e "${GREEN}No plugin files changed. Skipping validation.${NC}"
        exit 0
    fi
done

echo -e "${BLUE}Running plugin validation...${NC}"
echo ""

cd "$REPO_ROOT"

# Check that the validator script exists
if [ ! -f "scripts/validate_plugin.py" ]; then
    echo -e "${RED}ERROR: scripts/validate_plugin.py not found${NC}"
    echo -e "${RED}Cannot validate plugin. Push blocked.${NC}"
    exit 1
fi

# Use uv with --with pyyaml (needed since most plugins lack pyproject.toml)
# Falls back to python3 if uv is not available
set +e
if command -v uv &> /dev/null; then
    uv run --with pyyaml python scripts/validate_plugin.py . --verbose 2>&1
else
    python3 scripts/validate_plugin.py . --verbose 2>&1
fi
VALIDATION_EXIT_CODE=$?
set -e

echo ""

# Handle exit codes - strict mode: ALL non-zero exit codes block push
case $VALIDATION_EXIT_CODE in
    0)
        echo -e "${GREEN}========================================${NC}"
        echo -e "${GREEN}  PASSED: All validation checks passed${NC}"
        echo -e "${GREEN}  Push allowed.${NC}"
        echo -e "${GREEN}========================================${NC}"
        exit 0
        ;;
    1)
        echo -e "${RED}========================================${NC}"
        echo -e "${RED}  BLOCKED: CRITICAL issues found${NC}"
        echo -e "${RED}  Fix ALL issues before pushing.${NC}"
        echo -e "${RED}========================================${NC}"
        exit 1
        ;;
    2)
        echo -e "${RED}========================================${NC}"
        echo -e "${RED}  BLOCKED: MAJOR issues found${NC}"
        echo -e "${RED}  Fix ALL issues before pushing.${NC}"
        echo -e "${RED}========================================${NC}"
        exit 1
        ;;
    3)
        echo -e "${YELLOW}========================================${NC}"
        echo -e "${YELLOW}  BLOCKED: MINOR issues found${NC}"
        echo -e "${YELLOW}  Fix ALL issues before pushing.${NC}"
        echo -e "${YELLOW}========================================${NC}"
        exit 1
        ;;
    *)
        echo -e "${RED}========================================${NC}"
        echo -e "${RED}  ERROR: Validation failed (exit $VALIDATION_EXIT_CODE)${NC}"
        echo -e "${RED}  Please check the validation script.${NC}"
        echo -e "${RED}========================================${NC}"
        exit 1
        ;;
esac
